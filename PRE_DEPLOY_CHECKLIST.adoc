= Pre-Deployment Checklist

== Local Testing (Before Pi Transfer)

=== Code Status
* [x] Removed placeholder k6.py
* [x] Fixed main.py imports to use docker/k6/ library
* [x] Removed legacy script from Docker
* [x] Added transport-based draw_bounds method
* [x] Added image size validation (1600x1520 max)
* [x] Updated requirements.txt (Flask, Pillow, pyserial)

=== Pre-Flight Checks
* [ ] Run local syntax check: `python3 -m py_compile docker-wainlux/docker/app/main.py`
* [ ] Run local syntax check: `python3 -m py_compile docker-wainlux/docker/k6/*.py`
* [ ] Verify Dockerfile syntax
* [ ] Check compose.yaml syntax

== On Pi Zero W

=== System Preparation
* [ ] SSH access: `ssh user@pi-ip`
* [ ] Check disk space: `df -h` (need ~2GB free)
* [ ] Check swap: `free -h` (need 1GB)
* [ ] Verify USB device: `lsusb | grep CP210`
* [ ] Check device node: `ls -l /dev/ttyUSB0`

=== Docker Check
* [ ] Docker installed: `docker --version`
* [ ] User in docker group: `groups | grep docker`
* [ ] Docker running: `systemctl status docker`

=== Transfer and Build
* [ ] Sync code: `rsync -av --exclude='.git' wainlux-pi/ user@pi-ip:~/wainlux-pi/`
* [ ] Or: `ssh user@pi-ip "cd ~/wainlux-pi && git pull"`
* [ ] Build container: `docker compose build` (15-20 min)
* [ ] Check build success: `docker images | grep wainlux`

=== Deploy and Test
* [ ] Start service: `docker compose up -d`
* [ ] Check logs: `docker compose logs -f`
* [ ] Verify container running: `docker ps`
* [ ] Test HTTP: `curl http://localhost:8080/`
* [ ] Access web UI: `http://pi-ip:8080/`

=== Functional Tests
* [ ] Click CONNECT - should see "CONNECTED"
* [ ] Click HOME - laser homes to origin
* [ ] Click DRAW BOUNDS - traces 80x80mm rectangle
* [ ] Click DRAW Calibration - traces 10x10mm rectangle at each corner and one 2cm diameter circle in the center
* [ ] Upload small image - burns successfully
* [ ] Check CSV logs in `data/` directory

=== If Build Fails

==== Out of Memory
[source,bash]
----
# Increase swap
sudo dphys-swapfile swapoff
sudo nano /etc/dphys-swapfile
# Set CONF_SWAPSIZE=1024
sudo dphys-swapfile setup
sudo dphys-swapfile swapon
----

==== Missing Dependencies
[source,bash]
----
# Check Python availability
docker run --rm -it balenalib/raspberry-pi:bullseye python3 --version

# Interactive debug
docker run --rm -it -v $(pwd)/docker:/app balenalib/raspberry-pi:bullseye bash
cd /app
pip3 install -r requirements.txt
python3 -c "from k6.driver import WainluxK6; print('OK')"
----

==== USB Device Not Found
[source,bash]
----
# Reload udev rules
sudo udevadm control --reload-rules
sudo udevadm trigger

# Check permissions
ls -l /dev/ttyUSB0

# Manual permission (temporary)
sudo chmod 666 /dev/ttyUSB0
----

== Post-Deployment

=== Monitoring
* [ ] Set up log rotation for `data/*.csv`
* [ ] Monitor disk usage: `du -sh data/`
* [ ] Check container health: `docker stats wainlux-k6`

=== Optional: Auto-Start
* [ ] Create systemd service (see doing-deployment.adoc)
* [ ] Enable: `sudo systemctl enable wainlux-k6`
* [ ] Test reboot: `sudo reboot`

== Known Working Configurations

=== Raspberry Pi Zero W
* OS: Raspberry Pi OS Bullseye (32-bit)
* RAM: 512MB
* Swap: 1GB
* Docker: 20.10+
* Python: 3.9+

=== USB Device
* Wainlux K6 (CP2102 serial adapter)
* Vendor ID: 10c4
* Product ID: ea60
* Device: /dev/ttyUSB0
* Baud: 115200

== Rollback Plan

If new Docker fails:

[source,bash]
----
cd ~/wainlux-pi/docker-wainlux
docker compose down
git checkout <previous-commit>
docker compose build
docker compose up -d
----

Or use legacy script directly:
[source,bash]
----
cd ~/wainlux-pi/scripts
python3 k6_burn_image.py --help
----
