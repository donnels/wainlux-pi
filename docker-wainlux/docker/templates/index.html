{% extends "base.html" %}
{% from "macros.html" import navigation, status_display, connection_controls, test_controls, message_display %}

{% block title %}Wainlux K6{% endblock %}

{% block page_styles %}
.section { margin: 30px 0; }
.section h2 { margin-bottom: 15px; }
.section a { color: #fff; text-decoration: none; }
.section a:hover { text-decoration: underline; }
input[type="file"] { display: block; margin: 10px 0; color: #fff; }
{% endblock %}

{% block content %}
{{ navigation("WAINLUX K6", connected) }}

<div class="section">
    <a href="/calibration">→ CALIBRATION &amp; TESTING</a><br>
    <a href="/qr">→ WIFI QR CODE BURN</a>
</div>

{{ status_display(connected, k6_version if k6_version else "") }}
{{ connection_controls(connected) }}
{{ test_controls(connected) }}

<div class="section">
    <h2>ENGRAVE</h2>
    <input type="file" id="imageFile" accept="image/*">
    <button id="btnEngrave">BURN</button>
</div>

{{ message_display() }}
{% endblock %}

{% block page_script %}
    // Main app code
    let connected = false;
    
    const status = document.getElementById('status');
    const btnConnect = document.getElementById('btnConnect');
    const btnDisconnect = document.getElementById('btnDisconnect');
    const btnBounds = document.getElementById('btnBounds');
    const btnHome = document.getElementById('btnHome');
    const btnStop = document.getElementById('btnStop');
    const btnEngrave = document.getElementById('btnEngrave');
    const imageFile = document.getElementById('imageFile');
    
    let k6Version = '';
    
    function updateUI() {
        btnConnect.disabled = connected;
        btnDisconnect.disabled = !connected;
        
        if (connected) {
            status.textContent = k6Version ? `VERIFIED: K6 ${k6Version}` : 'VERIFIED';
            status.className = 'status';
        } else {
            status.textContent = 'NOT VERIFIED (verify optional)';
            status.className = 'status disconnected';
        }
    }
    
    btnConnect.addEventListener('click', async () => {
        const data = await apiCall('/api/connect');
        connected = data.connected;
        k6Version = data.version || '';
        updateUI();
        showMessage(`Connected to K6 ${k6Version}`);
    });
    
    btnDisconnect.addEventListener('click', async () => {
        await apiCall('/api/disconnect');
        connected = false;
        k6Version = '';
        updateUI();
        showMessage('Disconnected');
    });
    
    btnBounds.addEventListener('click', async () => {
        showMessage('Drawing bounds...');
        await apiCall('/api/test/bounds');
        showMessage('Bounds drawn');
    });
    
    btnHome.addEventListener('click', async () => {
        await apiCall('/api/test/home');
        showMessage('Homed');
    });
    
    btnStop.addEventListener('click', async () => {
        // EMERGENCY STOP - no confirmation, immediate action
        try {
            await apiCall('/api/test/stop');
            showMessage('STOP command sent');
        } catch (err) {
            showMessage('Stop failed: ' + err.message, true);
        }
    });
    
    btnEngrave.addEventListener('click', async () => {
        if (!imageFile.files[0]) {
            showMessage('Select an image', true);
            return;
        }
        
        const formData = new FormData();
        formData.append('image', imageFile.files[0]);
        
        showMessage('Engraving...');
        await apiCall('/api/engrave', 'POST', formData);
        showMessage('Engraved');
    });
    
    // Initial state
    updateUI();
{% endblock %}
