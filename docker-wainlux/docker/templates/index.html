{% extends "base.html" %}
{% from "macros.html" import navigation, message_display %}

{% block title %}Wainlux K6{% endblock %}

{% block page_styles %}
.section { margin: 30px 0; }
.section h2 { margin-bottom: 15px; }
.section a { color: #fff; text-decoration: none; }
.section a:hover { text-decoration: underline; }
input[type="file"] { display: block; margin: 10px 0; color: #fff; }
{% endblock %}

{% block content %}
{{ navigation("WAINLUX K6") }}

<div class="section">
    <a href="/calibration">→ CALIBRATION &amp; TESTING</a><br>
    <a href="/qr">→ QR GENERATE</a><br>
    <a href="/alignment-builder">→ MATERIAL & POSITIONING</a><br>
    <a href="/burn">→ QUICK BURN (with defaults)</a><br>
    <a href="/preview-tests">→ PREVIEW ENGINE TESTS</a><br>
    <button id="btnVerify" style="margin-top: 12px;">VERIFY K6</button>
</div>

<div class="section">
    <h2>IMAGE SELECTION</h2>
    
    <div class="form-row">
        <label>SELECT IMAGE:</label>
        <select id="imageSelect" style="flex: 1; max-width: 400px;">
            <option value="">-- Select sample image --</option>
        </select>
    </div>
    
    <div class="form-row" style="margin-top: 10px;">
        <label>OR UPLOAD:</label>
        <input type="file" id="imageFile" accept="image/*" style="flex: 1; max-width: 400px;">
    </div>
    
    <div id="previewSection" style="display: none; margin-top: 20px; text-align: center;">
        <h3>PREVIEW</h3>
        <img id="previewImage" style="max-width: 400px; max-height: 400px; border: 1px solid #fff;" alt="Image Preview">
        <div id="previewInfo" style="margin-top: 10px; font-size: 0.9em;"></div>
    </div>
    
    <button id="btnNext" style="margin-top: 15px;">NEXT →</button>
</div>

{{ message_display() }}
{% endblock %}

{% block page_script %}
    // Main app code
    const modeDisplay = document.getElementById('modeDisplay');
    const firmwareDisplay = document.getElementById('firmwareDisplay');
    const verifyDisplay = document.getElementById('verifyDisplay');
    const btnVerify = document.getElementById('btnVerify');
    const btnNext = document.getElementById('btnNext');
    const imageFile = document.getElementById('imageFile');
    const imageSelect = document.getElementById('imageSelect');
    const previewSection = document.getElementById('previewSection');
    const previewImage = document.getElementById('previewImage');
    const previewInfo = document.getElementById('previewInfo');
    
    let currentImageData = null;
    let imageLoadVersion = 0;
    let sampleImages = [];

    function updateImagePreview(imageData) {
        previewImage.src = imageData.image_base64;
        const sizeInfo = `${imageData.width} × ${imageData.height}px`;
        const originalInfo = imageData.resized
            ? ` (scaled from ${imageData.original_width} × ${imageData.original_height}px)`
            : '';
        const sourceInfo = imageData.source_reference ? ` | source: ${imageData.source_reference}` : '';
        previewInfo.textContent = `${imageData.original_filename} (${sizeInfo})${originalInfo}${sourceInfo}`;
        previewSection.style.display = 'block';
        updateNextButtonText();
    }
    
    // Load sample images
    async function loadSampleImages() {
        try {
            const data = await apiCall('/api/images/list', 'GET');
            sampleImages = data.images || [];
            
            // Populate dropdown
            imageSelect.innerHTML = '<option value="">-- Select sample image --</option>';
            sampleImages.forEach(img => {
                const opt = document.createElement('option');
                opt.value = img.url;
                opt.textContent = img.name;
                
                // Select default-image.png by default
                if (img.name === 'default-image.png') {
                    opt.selected = true;
                }
                
                imageSelect.appendChild(opt);
            });
            
            // Auto-load default image preview
            if (imageSelect.value) {
                await loadImagePreview(imageSelect.value, 'default-image.png');
            }
        } catch (err) {
            console.error('Failed to load sample images:', err);
        }
    }
    
    // Load and display image preview
    async function loadImagePreview(url, filename) {
        const loadVersion = ++imageLoadVersion;
        try {
            const prepared = await ingestImageUrl(url, filename, { source: 'selection', sourceReference: url });
            if (loadVersion !== imageLoadVersion) return;
            currentImageData = buildUploadStageData(prepared).data;
            currentImageData.url = url;
            updateImagePreview(currentImageData);
        } catch (err) {
            console.error('Failed to load image preview:', err);
            showMessage('Failed to load image preview', true);
        }
    }
    
    // Update Next button text based on workflow state
    function updateNextButtonText() {
        const config = getMaterialConfig();
        if (config && config.material && Object.keys(config.material).length > 0) {
            btnNext.textContent = 'REVIEW & BURN →';
            btnNext.style.background = '#2a2a2a';
            return;
        }
        btnNext.textContent = 'NEXT: MATERIAL & POSITIONING →';
        btnNext.style.background = '';
    }
    
    // Handle image selection change
    imageSelect.addEventListener('change', async (e) => {
        if (e.target.value) {
            const filename = e.target.value.split('/').pop();
            await loadImagePreview(e.target.value, filename);
        }
    });
    
    // Handle file upload
    imageFile.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file) {
            const loadVersion = ++imageLoadVersion;
            try {
                const sourceReference = file.webkitRelativePath || file.name;
                const prepared = await ingestImageBlob(file, file.name, { source: 'upload', sourceReference });
                if (loadVersion !== imageLoadVersion) return;
                currentImageData = buildUploadStageData(prepared).data;
                updateImagePreview(currentImageData);
            } catch (err) {
                if (loadVersion !== imageLoadVersion) return;
                console.error('Failed to process uploaded image:', err);
                showMessage(err.message || 'Failed to process uploaded image', true);
            }
        }
    });
    
    // Status bar functions now in shared api.js
    
    btnVerify.addEventListener('click', async () => {
        const data = await verifyConnectionAndRefreshStatus();
        showMessage(`K6 ${data.version || ''} verified`);
    });
    
    btnNext.addEventListener('click', async () => {
        if (!currentImageData) {
            showMessage('Select or upload an image first', true);
            return;
        }
        
        // Build job structure with image data
        const job = {
            version: '1.0',
            stages: {
                upload: {
                    status: 'complete',
                    data: currentImageData
                }
            },
            material: {},
            layout: {}
        };
        
        // Check if material/positioning already configured
        const config = getMaterialConfig();
        if (config) {
            if (config._meta) {
                job._meta = { ...config._meta };
            }
            if (config.material && Object.keys(config.material).length > 0) {
                // Material configured -> go to burn page
                job.material = config.material;
                job.layout = config.layout || {};
                
                // Save updated job
                try {
                    saveMaterialConfig(job);
                } catch (err) {
                    showMessage('Could not save workflow state: ' + err.message, true);
                    return;
                }
                
                showMessage('Opening burn page with saved material settings...');
                window.location.href = '/burn';
                return;
            }
        }
        
        // No material configured → go to alignment-builder
        try {
            saveMaterialConfig(job);
        } catch (err) {
            showMessage('Could not save workflow state: ' + err.message, true);
            return;
        }
        showMessage('Redirecting to material & positioning...');
        setTimeout(() => {
            window.location.href = '/alignment-builder';
        }, 500);
    });
    
    // Initial load
    refreshStatus();
    loadSampleImages();
{% endblock %}
