{% extends "base.html" %}

{% block title %}QR Generate{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="/static/css/components.css">
{% endblock %}

{% block page_styles %}
.container { max-width: 900px; }
.form-row input[type="text"], 
.form-row input[type="password"], 
.form-row input[type="number"] {
    flex: 1;
    max-width: 400px;
}
#progressSection {
    margin-top: 20px;
    padding: 20px;
    border: 1px solid #fff;
}
.progress-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #fff;
    font-weight: bold;
    font-size: 1.1em;
    text-shadow: 0 0 3px #000;
}
#logBox {
    font-family: monospace;
    font-size: 0.9em;
    white-space: pre-wrap;
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #fff;
    padding: 10px;
    margin-top: 15px;
    background: #000;
}
{% endblock %}

{% block content %}
<h1>QR GENERATE</h1>

<div class="nav">
    <a href="/">← MAIN</a>
    <a href="/alignment-builder">MATERIAL & POSITIONING</a>
    <a href="/qr">QR GENERATE</a>
</div>

<div id="status" class="status {% if not connected %}disconnected{% endif %}">
    {% if connected %}Verified K6 connectivity{% else %}K6 connectivity not verified (optional){% endif %}
</div>

<div class="section">
    <h2>QR TYPE</h2>
    <div class="form-row">
        <label>QR TYPE:</label>
        <select id="qrType">
            <option value="wifi">WiFi Credentials</option>
        </select>
    </div>
</div>

<div class="section" id="wifiSection">
    <h2>WIFI CREDENTIALS</h2>
    <div class="info" style="margin-bottom: 15px;">
        Generate WiFi QR code. Default output: 75 × 53.98mm (fits credit card).<br>
        QR code includes SSID and password. Password is NOT displayed as text (security).
    </div>
    
    <div class="form-row">
        <label>SSID (Network Name):</label>
        <input type="text" id="ssid" placeholder="MyWiFiNetwork" required>
    </div>
    
    <div class="form-row">
        <label>PASSWORD:</label>
        <input type="password" id="password" placeholder="wifi password">
    </div>
    
    <div class="form-row">
        <label>SECURITY:</label>
        <select id="security">
            <option value="WPA">WPA/WPA2</option>
            <option value="WEP">WEP</option>
            <option value="nopass">No Password</option>
        </select>
    </div>
    
    <div class="form-row">
        <label>DESCRIPTION (optional):</label>
        <input type="text" id="description" placeholder="Guest WiFi">
    </div>
    
    <div class="form-row">
        <label>
            <input type="checkbox" id="showPassword" style="width: auto; margin-right: 8px;">
            Show password as text in image
        </label>
    </div>
    
    <button id="btnGenerate">GENERATE QR PREVIEW</button>
</div>

<div id="previewSection" style="display: none;">
    <h2>QR CODE PREVIEW</h2>
    <div class="info">
        Scan with phone to verify QR is correct.<br>
        Size: 75 × 53.98mm (1500 × 1080px @ 0.05mm/px K6 native resolution)
    </div>
    <img id="previewImage" alt="QR Preview">
    <div id="previewInfo" style="margin-top: 10px;"></div>
    
    <div style="margin-top: 20px;">
        <button id="btnNext" style="font-size: 1.2em; padding: 12px 24px;">NEXT: MATERIAL & POSITIONING →</button>
    </div>
</div>

<div id="progressSection" style="display: none;">
    <h2>SAVING TO SESSION</h2>
    <div class="info">
        QR code saved. Redirecting to material & positioning...
    </div>
    
    <!-- Upload Progress -->
    <div style="margin-bottom: 15px;">
        <label>UPLOAD:</label>
        <div class="progress-bar">
            <div id="uploadFill" class="progress-fill" style="width: 0%;"></div>
            <div id="uploadText" class="progress-text">0%</div>
        </div>
    </div>
    
    <!-- Burn Progress -->
    <div style="margin-bottom: 15px;">
        <label>BURNING:</label>
        <div class="progress-bar">
            <div id="burnFill" class="progress-fill" style="width: 0%;"></div>
            <div id="burnText" class="progress-text">0%</div>
        </div>
    </div>
    
    <div id="logBox"></div>
</div>

<div id="message"></div>
{% endblock %}

{% block extra_js %}
    <script src="/static/js/progress.js"></script>
    <script src="/static/js/log.js"></script>
{% endblock %}

{% block page_script %}
const ssid = document.getElementById('ssid');
const password = document.getElementById('password');
const security = document.getElementById('security');
const description = document.getElementById('description');
const showPassword = document.getElementById('showPassword');
const btnGenerate = document.getElementById('btnGenerate');
const btnNext = document.getElementById('btnNext');
const message = document.getElementById('message');
const previewSection = document.getElementById('previewSection');
const previewImage = document.getElementById('previewImage');
const previewInfo = document.getElementById('previewInfo');
const status = document.getElementById('status');

let currentQRData = null;  // Store QR generation result

// Check connection status (uses shared updateStatusDisplay from base.html)
updateStatusDisplay(status);

btnGenerate.addEventListener('click', async () => {
    if (!ssid.value) {
        showMessage('SSID required', true);
        return;
    }
    
    btnGenerate.disabled = true;
    showMessage('Generating QR code...');
    
    try {
        const result = await apiCall('/api/qr/generate', 'POST', {
            ssid: ssid.value,
            password: password.value,
            security: security.value,
            description: description.value,
            show_password: showPassword.checked
        });
        
        previewImage.src = result.image;
        previewInfo.textContent = `Size: ${result.size_mm} (${result.width}×${result.height}px)`;
        previewSection.style.display = 'block';
        currentQRData = result;  // Store full result for Next button
        showMessage('QR generated - scan with phone to verify, then click NEXT');
    } catch (err) {
        showMessage('Generate failed: ' + err.message, true);
    } finally {
        btnGenerate.disabled = false;
    }
});

btnNext.addEventListener('click', () => {
    if (!currentQRData) {
        showMessage('Generate QR first', true);
        return;
    }
    
    // Build job structure with QR data
    const job = {
        version: '1.0',
        stages: {
            upload: {
                status: 'complete',
                data: {
                    image_path: currentQRData.temp_path,
                    image_base64: currentQRData.image_base64,
                    original_filename: `WiFi QR: ${ssid.value}`,
                    source: 'qr_generation',
                    width: currentQRData.width,
                    height: currentQRData.height
                }
            }
        },
        material: {},
        layout: {}
    };
    
    // Save to session storage for alignment-builder
    sessionStorage.setItem('materialConfig', JSON.stringify(job));
    
    // Redirect to alignment-builder
    showMessage('Redirecting to material & positioning...');
    setTimeout(() => {
        window.location.href = '/alignment-builder';
    }, 500);
});
{% endblock %}
