= Docker Wainlux K6 (build and run)

Container for K6 laser control.

== Build

[source,bash]
----
docker compose build
----

Takes a long time on Pi Zero W. Long time is expected due to ARMv6 architecture and limited resources. A long time can be a VERY long time (in times of TikTok expectations of short clips, and attention spans, some might say forever). Mitigation can be to build with buildx and QEMU on a more powerful machine, then push to a registry and pull on the Pi. The 1st Gen Pi Zero is the problem here as support for it is dwindling so there are less pre built wheels available and building these costs the most time.

== Use Prebuilt ARMv6 Image (GHCR)

The GitHub Actions workflow `.github/workflows/build-container-armv6.yml` builds and publishes:

* `ghcr.io/<owner>/<repo>:latest` (main branch)
* `ghcr.io/<owner>/<repo>:sha-<commit>`

[source,bash]
----
# Login once (needs read:packages permission on your token if private)
echo "$GHCR_TOKEN" | docker login ghcr.io -u <github-username> --password-stdin

# Pull the latest ARMv6 image built by Actions
docker pull ghcr.io/<owner>/<repo>:latest
----

To run with compose from a prebuilt image, set `image:` for the service in `compose.yaml`
to `ghcr.io/<owner>/<repo>:latest` and remove/ignore the `build:` entry.

== Run

[source,bash]
----
docker compose up -d
----

Browse: `http://<pi-ip>:8080`

== Configuration

* *Device*: `/dev/ttyUSB0`
* *Port*: `8080`
* *Privileged*: Required for serial
* *Volume*: `./data`

== Testing Modes

=== Mock Mode (No Hardware)

Test without K6 connected. Uses simulated transport layer.

[source,bash]
----
# Run with mock device
docker compose -f compose-dev.yaml up -d
----

Or set environment variable:

[source,bash]
----
export K6_MOCK_DEVICE=true
----

* Simulates protocol responses (VERSION, ACK, STATUS)
* Returns version v0.0.1
* No serial hardware required
* Use for development, CI/CD, Steam Deck testing

=== Dry Run Mode (Real K6, No Burn)

Test with real K6 connected but disable laser firing.

* Enable via Settings page or API: `POST /api/settings {"dry_run": true}`
* Sends all commands including data upload
* Tests complete protocol flow
* Skips INIT commands that start laser
* Use for testing with new material or verifying positioning
* Works with both real hardware and mock mode

=== Operation Modes (Workflow Testing)

Control logging and intermediate file generation:

* *SILENT* (default): Monolithic pipeline, minimal logs, production use
* *VERBOSE*: Save all intermediates (.npy, .bin, CSV logs), debugging
* *SINGLE-STEP*: Manual approval at each stage (NOT YET IMPLEMENTED)

Set via Settings page or API: `POST /api/settings {"operation_mode": "verbose"}`

== Commands

[source,bash]
----
# View logs
docker compose logs -f

# Stop
docker compose down

# Rebuild
docker compose build --no-cache
----
