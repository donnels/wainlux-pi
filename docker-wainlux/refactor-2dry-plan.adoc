= Refactor Status & Plan
:toc:
:toclevels: 2

Last Updated: 2026-01-29

== Summary

**Frontend**: DRY complete, deployed, tested ✓  
**Backend**: Cleaned up imports and constants ✓  
**Next**: Pre-commit checks, then optional backend architecture refactor

=== Current State

**Files**
[options="header"]
|===
|File |Lines |Status
|app/main.py |1567 |Cleaned (was 1660)
|templates/*.html |3317 |DRY complete
|static/css/*.css |248 |Shared
|static/js/*.js |188 |Components
|k6/*.py |~2500 |Clean library
|===

**What Works**
* All pages use base.html + macros.html pattern
* Shared CSS/JS components (Progress, Log, API)
* Connection verification optional (not mandatory)
* Image import bugs fixed
* Magic numbers replaced with constants
* ProgressCSVLogger extracted (was duplicated 2×)
* XSS vulnerability fixed
* API timeout added (30s)
* Deployed and tested on Pi Zero W

**What's Left**
* Pre-commit checks (linter, tests)
* Optional: Backend architecture refactor (30-40h)

== Next Steps

=== Immediate: Pre-commit ⏳

**Run checks**
[source,bash]
----
cd docker-wainlux/docker
python3 -m py_compile app/*.py k6/*.py  # ✓ Already passing
python3 -m flake8 app/ k6/ --max-line-length=100  # Run linter
python3 -m black --check app/ k6/  # Check formatting
----

**If linter fails**: Fix issues, re-test

**Commit**
[source,bash]
----
git add -A
git commit -m "refactor: frontend DRY + backend cleanup complete

Frontend (-548 lines duplicate):
- Shared CSS/JS components
- base.html + macros.html pattern
- Fixed XSS, timeout, Image imports
- Connection verification optional

Backend (-93 lines, +constants):
- Extracted ProgressCSVLogger class
- Moved 9 imports to top
- Replaced 40+ magic numbers with K6_* constants
- main.py: 1660 → 1567 lines

Total: -641 lines (-13%), tested on Pi"
git push
----

=== Optional: Backend Architecture Refactor

**Only if needed. Current code works and is maintainable.**

==== Problem: God Object (main.py 1567 lines)

**Current structure**:
* 26 route handlers in one file
* Business logic mixed with Flask routes
* Global state (k6_transport, progress_queue)
* No service layer, no testing
* SSE shared queue (multi-client issues)

**Proposed refactor** (30-40 hours):
1. Extract services/k6_service.py - laser operations
2. Extract services/image_service.py - image processing
3. Extract services/progress_service.py - per-client SSE
4. Extract services/qr_service.py - QR generation
5. Remove global state → K6DeviceManager class
6. Fix SSE → per-client streams with IDs
7. Add unit tests with MockTransport
8. Configuration management

**Result**: main.py ~400 lines, testable services

==== Problem: SSE Multi-Client (Shared Queue)

**Current**: All clients receive all events from shared progress_queue  
**Impact**: Multiple browsers see each other's progress  
**Fix**: Per-client Queue stored in active_streams dict

**Priority**: LOW (single-user device, works fine)

==== Problem: No Request Serialization

**Current**: Multiple burns can run simultaneously  
**Impact**: Serial port command interleaving  
**Fix**: Lock mechanism or burn queue

**Priority**: LOW (single-user device)

==== Problem: No Validation Layer

**Current**: Validation scattered in routes  
**Impact**: Repeated logic, inconsistent checks  
**Fix**: Centralized validator functions

**Priority**: LOW (current validation adequate)

== Decision Matrix

[options="header"]
|===
|Action |Time |Value |Priority |Decision
|Pre-commit checks |1h |High |HIGH |DO NOW
|Extract services |20h |Medium |LOW |DEFER
|Fix SSE isolation |4h |Low |LOW |DEFER
|Add testing |10h |High |MEDIUM |DEFER
|Validation layer |3h |Low |LOW |SKIP
|===

**Recommendation**: Commit now, defer backend refactor until needed.

== Architectural Issues (Documented, Not Urgent)

**For future reference when backend refactor needed:**

=== Layer Violations
* God Object: 26 routes + business logic in main.py
* No service layer: Routes call driver/protocol directly
* Global state: k6_transport, progress_queue module-level
* ProgressCSVLogger was nested in functions (now extracted ✓)

=== State Management
* No connection lifecycle (heartbeat, reconnect)
* No request serialization (concurrent burns possible)
* burn_in_progress flag unused
* SSE stream lifecycle unmanaged

=== Error Handling
* Inconsistent patterns across routes
* No centralized handler
* No error codes beyond HTTP 400/500
* Validation scattered

=== Code Quality Issues (FIXED ✓)
* [x] Duplicate ProgressCSVLogger class → extracted
* [x] Inline PIL/numpy imports → moved to top
* [x] Magic numbers → K6_* constants
* [x] XSS in qr.html log display → createElement
* [x] API timeout missing → 30s AbortController
* [x] Image import errors → fixed

**Total Issues**: 60+ documented  
**Priority**: None critical, all "nice to have"  
**Current Code**: Works correctly for single-user Pi Zero W use case

== Summary

✅ **Frontend DRY**: Complete, tested, deployed  
✅ **Backend Cleanup**: Imports, constants, deduplication done  
⏳ **Pre-commit**: Run linter, commit  
⏸️ **Backend Refactor**: Defer (30-40h), not urgent

**Code quality**: Good enough  
**Functionality**: Working correctly  
**Next milestone**: Ship v0.2, refactor later if needed
